<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passport Demo Web</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>Демо: сканирование загранпаспорта</h1>

    <section class="card">
      <h2>Статус</h2>
      <div id="status" class="status">Ожидаю NFC-сканирование...</div>
    </section>

    <section class="card">
      <h2>Распознавание с веб-камеры</h2>
      <div class="webcam-container">
        <div class="webcam-preview">
          <video id="webcam-video" autoplay playsinline></video>
          <div id="webcam-placeholder" class="webcam-placeholder">
            Нажмите "Включить камеру" для предпросмотра
          </div>
        </div>
        <canvas id="snapshot-canvas" style="display: none;"></canvas>
      </div>
      <div class="webcam-controls">
        <button id="btn-camera-toggle" class="btn btn-secondary">Включить камеру</button>
        <button id="btn-snapshot" class="btn btn-primary" disabled>Сделать снимок и распознать</button>
      </div>
      <div id="webcam-status" class="webcam-status"></div>
      <div id="recognition-result" class="recognition-result" style="display: none;">
        <h3>Результат распознавания</h3>
        <div id="result-content"></div>
      </div>
    </section>

    <section class="card">
      <h2>Фото из NFC</h2>
      <div class="photo">
        <img id="face" alt="Фото появится после NFC-сканирования" />
      </div>
      <div id="meta" class="meta"></div>
    </section>
  </main>

  <script>
    const statusEl = document.getElementById("status");
    const faceEl = document.getElementById("face");
    const metaEl = document.getElementById("meta");
    const ERROR_REPORT_INTERVAL_MS = 5000;
    let lastErrorReportAt = 0;

    function shouldReportError() {
      const now = Date.now();
      if (now - lastErrorReportAt < ERROR_REPORT_INTERVAL_MS) {
        return false;
      }
      lastErrorReportAt = now;
      return true;
    }

    function reportError({ error_message, stacktrace, context_json }) {
      if (!shouldReportError()) {
        return;
      }
      const payload = {
        platform: "web",
        error_message: error_message || "Unknown error",
        stacktrace: stacktrace || null,
        context_json: context_json || null,
        user_agent: navigator.userAgent,
      };

      fetch("/api/errors", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true,
      }).catch(() => {});
    }

    function connect() {
      const es = new EventSource("/api/events");
      es.addEventListener("nfc_scan_success", (evt) => {
        try {
          const data = JSON.parse(evt.data);
          statusEl.textContent = "NFC-сканирование успешно. scan_id=" + data.scan_id;
          faceEl.src = data.face_image_url;
          metaEl.textContent = "Источник: " + data.face_image_url;
        } catch (e) {
          statusEl.textContent = "Ошибка парсинга события";
        }
      });
      es.onerror = () => {
        statusEl.textContent = "Потеряно соединение. Переподключаюсь...";
        reportError({
          error_message: "EventSource connection error",
          context_json: {
            stream_url: "/api/events",
            ready_state: es.readyState,
          },
        });
        es.close();
        setTimeout(connect, 1000);
      };
    }

    connect();

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({
        error_message: String(message),
        stacktrace: error && error.stack ? error.stack : null,
        context_json: {
          source,
          lineno,
          colno,
        },
      });
    };

    window.addEventListener("unhandledrejection", (event) => {
      let reasonMessage = "Unhandled promise rejection";
      let reasonStack = null;
      if (event.reason instanceof Error) {
        reasonMessage = event.reason.message || reasonMessage;
        reasonStack = event.reason.stack || null;
      } else if (typeof event.reason === "string") {
        reasonMessage = event.reason;
      } else {
        try {
          reasonMessage = JSON.stringify(event.reason);
        } catch (e) {
          reasonMessage = String(event.reason);
        }
      }

      reportError({
        error_message: "Unhandled promise rejection: " + reasonMessage,
        stacktrace: reasonStack,
        context_json: {
          reason: reasonMessage,
        },
      });
    });

    // ============================================================
    // Webcam functionality
    // ============================================================
    const videoEl = document.getElementById("webcam-video");
    const canvasEl = document.getElementById("snapshot-canvas");
    const placeholderEl = document.getElementById("webcam-placeholder");
    const btnToggle = document.getElementById("btn-camera-toggle");
    const btnSnapshot = document.getElementById("btn-snapshot");
    const webcamStatusEl = document.getElementById("webcam-status");
    const resultContainer = document.getElementById("recognition-result");
    const resultContent = document.getElementById("result-content");

    let mediaStream = null;
    let isRecognizing = false;

    async function startCamera() {
      try {
        webcamStatusEl.textContent = "Запрашиваю доступ к камере...";
        webcamStatusEl.className = "webcam-status";

        // Request camera with maximum resolution
        const constraints = {
          video: {
            width: { ideal: 4096 },
            height: { ideal: 2160 },
            facingMode: "environment"
          },
          audio: false
        };

        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = mediaStream;

        // Wait for video to be ready
        await new Promise((resolve) => {
          videoEl.onloadedmetadata = () => {
            videoEl.play();
            resolve();
          };
        });

        const track = mediaStream.getVideoTracks()[0];
        const settings = track.getSettings();
        const actualWidth = settings.width || videoEl.videoWidth;
        const actualHeight = settings.height || videoEl.videoHeight;

        placeholderEl.style.display = "none";
        videoEl.style.display = "block";
        btnToggle.textContent = "Выключить камеру";
        btnSnapshot.disabled = false;
        webcamStatusEl.textContent = `Камера активна (${actualWidth}×${actualHeight})`;
        webcamStatusEl.className = "webcam-status success";

      } catch (err) {
        console.error("Camera error:", err);
        webcamStatusEl.textContent = "Ошибка доступа к камере: " + err.message;
        webcamStatusEl.className = "webcam-status error";
        reportError({
          error_message: "Camera access error: " + err.message,
          context_json: { error_name: err.name }
        });
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      videoEl.srcObject = null;
      videoEl.style.display = "none";
      placeholderEl.style.display = "flex";
      btnToggle.textContent = "Включить камеру";
      btnSnapshot.disabled = true;
      webcamStatusEl.textContent = "";
      webcamStatusEl.className = "webcam-status";
    }

    btnToggle.addEventListener("click", () => {
      if (mediaStream) {
        stopCamera();
      } else {
        startCamera();
      }
    });

    btnSnapshot.addEventListener("click", async () => {
      if (!mediaStream || isRecognizing) return;

      isRecognizing = true;
      btnSnapshot.disabled = true;
      btnSnapshot.textContent = "Распознавание...";
      webcamStatusEl.textContent = "Делаю снимок и отправляю на распознавание...";
      webcamStatusEl.className = "webcam-status";
      resultContainer.style.display = "none";

      try {
        // Get actual video dimensions for max resolution snapshot
        const track = mediaStream.getVideoTracks()[0];
        const settings = track.getSettings();
        const width = settings.width || videoEl.videoWidth;
        const height = settings.height || videoEl.videoHeight;

        // Capture snapshot at full resolution
        canvasEl.width = width;
        canvasEl.height = height;
        const ctx = canvasEl.getContext("2d");
        ctx.drawImage(videoEl, 0, 0, width, height);

        // Convert to blob
        const blob = await new Promise((resolve) => {
          canvasEl.toBlob(resolve, "image/jpeg", 0.95);
        });

        // Send to recognition API
        const formData = new FormData();
        formData.append("image", blob, "snapshot.jpg");

        const response = await fetch("/api/recognize", {
          method: "POST",
          body: formData
        });

        const result = await response.json();

        // Display result
        resultContainer.style.display = "block";
        if (result.error) {
          resultContent.innerHTML = `<div class="result-error">Ошибка: ${escapeHtml(result.error)}</div>`;
          webcamStatusEl.textContent = "Распознавание завершено с ошибкой";
          webcamStatusEl.className = "webcam-status error";
        } else {
          resultContent.innerHTML = `
            <div class="result-success">
              <div class="result-row"><span class="result-label">Номер документа:</span> <span class="result-value">${escapeHtml(result.document_number || "—")}</span></div>
              <div class="result-row"><span class="result-label">Дата рождения:</span> <span class="result-value">${formatDate(result.date_of_birth)}</span></div>
              <div class="result-row"><span class="result-label">Дата истечения:</span> <span class="result-value">${formatDate(result.date_of_expiry)}</span></div>
            </div>
          `;
          webcamStatusEl.textContent = "Распознавание успешно завершено";
          webcamStatusEl.className = "webcam-status success";
        }

      } catch (err) {
        console.error("Recognition error:", err);
        resultContainer.style.display = "block";
        resultContent.innerHTML = `<div class="result-error">Ошибка сети: ${escapeHtml(err.message)}</div>`;
        webcamStatusEl.textContent = "Ошибка при распознавании";
        webcamStatusEl.className = "webcam-status error";
        reportError({
          error_message: "Recognition request error: " + err.message,
          stacktrace: err.stack || null
        });
      } finally {
        isRecognizing = false;
        btnSnapshot.disabled = false;
        btnSnapshot.textContent = "Сделать снимок и распознать";
      }
    });

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function formatDate(yymmdd) {
      if (!yymmdd || yymmdd.length !== 6) return yymmdd || "—";
      const yy = yymmdd.substring(0, 2);
      const mm = yymmdd.substring(2, 4);
      const dd = yymmdd.substring(4, 6);
      const year = parseInt(yy, 10);
      const fullYear = year > 50 ? 1900 + year : 2000 + year;
      return `${dd}.${mm}.${fullYear}`;
    }
  </script>
</body>
</html>
