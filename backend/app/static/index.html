<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Passport Demo Web</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <main class="container">
    <h1>Демо: сканирование загранпаспорта</h1>

    <section class="card">
      <h2>Статус</h2>
      <div id="status" class="status">Ожидаю NFC-сканирование...</div>
    </section>

    <section class="card">
      <h2>Распознавание с веб-камеры</h2>
      <div class="webcam-container">
        <div class="webcam-preview">
          <video id="webcam-video" autoplay playsinline muted></video>
          <div id="webcam-placeholder" class="webcam-placeholder">
            Нажмите "Включить камеру" для предпросмотра
          </div>
        </div>
        <canvas id="snapshot-canvas" style="display: none;"></canvas>
      </div>
      <div class="webcam-controls">
        <button id="btn-camera-toggle" class="btn btn-secondary">Включить камеру</button>
        <button id="btn-camera-switch" class="btn btn-secondary btn-icon" disabled title="Переключить камеру">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5"/>
            <path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5"/>
            <circle cx="12" cy="12" r="3"/>
            <path d="m18 22-3-3 3-3"/>
            <path d="m6 2 3 3-3 3"/>
          </svg>
        </button>
        <button id="btn-snapshot" class="btn btn-primary" disabled>Сделать снимок и распознать</button>
      </div>
      <div id="webcam-status" class="webcam-status"></div>
      <div id="recognition-result" class="recognition-result" style="display: none;">
        <h3>Результат распознавания</h3>
        <div id="result-content"></div>
      </div>
    </section>

    <section class="card">
      <h2>Фото из NFC</h2>
      <div class="photo">
        <img id="face" alt="Фото появится после NFC-сканирования" />
      </div>
      <div id="meta" class="meta"></div>
    </section>
  </main>

  <script src="/static/webcam.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const faceEl = document.getElementById("face");
    const metaEl = document.getElementById("meta");
    const ERROR_REPORT_INTERVAL_MS = 5000;
    let lastErrorReportAt = 0;

    function shouldReportError() {
      const now = Date.now();
      if (now - lastErrorReportAt < ERROR_REPORT_INTERVAL_MS) {
        return false;
      }
      lastErrorReportAt = now;
      return true;
    }

    function reportError({ error_message, stacktrace, context_json }) {
      if (!shouldReportError()) {
        return;
      }
      const payload = {
        platform: "web",
        error_message: error_message || "Unknown error",
        stacktrace: stacktrace || null,
        context_json: context_json || null,
        user_agent: navigator.userAgent,
      };

      fetch("/api/errors", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true,
      }).catch(() => {});
    }

    function connect() {
      const es = new EventSource("/api/events");
      es.addEventListener("nfc_scan_success", (evt) => {
        try {
          const data = JSON.parse(evt.data);
          statusEl.textContent = "NFC-сканирование успешно. scan_id=" + data.scan_id;
          faceEl.src = data.face_image_url;
          metaEl.textContent = "Источник: " + data.face_image_url;
        } catch (e) {
          statusEl.textContent = "Ошибка парсинга события";
        }
      });
      es.onerror = () => {
        statusEl.textContent = "Потеряно соединение. Переподключаюсь...";
        reportError({
          error_message: "EventSource connection error",
          context_json: {
            stream_url: "/api/events",
            ready_state: es.readyState,
          },
        });
        es.close();
        setTimeout(connect, 1000);
      };
    }

    connect();

    window.onerror = (message, source, lineno, colno, error) => {
      reportError({
        error_message: String(message),
        stacktrace: error && error.stack ? error.stack : null,
        context_json: {
          source,
          lineno,
          colno,
        },
      });
    };

    window.addEventListener("unhandledrejection", (event) => {
      let reasonMessage = "Unhandled promise rejection";
      let reasonStack = null;
      if (event.reason instanceof Error) {
        reasonMessage = event.reason.message || reasonMessage;
        reasonStack = event.reason.stack || null;
      } else if (typeof event.reason === "string") {
        reasonMessage = event.reason;
      } else {
        try {
          reasonMessage = JSON.stringify(event.reason);
        } catch (e) {
          reasonMessage = String(event.reason);
        }
      }

      reportError({
        error_message: "Unhandled promise rejection: " + reasonMessage,
        stacktrace: reasonStack,
        context_json: {
          reason: reasonMessage,
        },
      });
    });

    // ============================================================
    // Webcam functionality
    // ============================================================
    const webcamController = WebcamUI.init({
      videoEl: document.getElementById("webcam-video"),
      canvasEl: document.getElementById("snapshot-canvas"),
      placeholderEl: document.getElementById("webcam-placeholder"),
      btnToggle: document.getElementById("btn-camera-toggle"),
      btnCameraSwitch: document.getElementById("btn-camera-switch"),
      btnSnapshot: document.getElementById("btn-snapshot"),
      webcamStatusEl: document.getElementById("webcam-status"),
      resultContainer: document.getElementById("recognition-result"),
      resultContent: document.getElementById("result-content"),
      reportError,
      fetchImpl: window.fetch ? window.fetch.bind(window) : null,
      mediaDevices: navigator.mediaDevices,
      FormDataClass: window.FormData
    });
  </script>
</body>
</html>
